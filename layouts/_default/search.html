{{ define "main" }}
<section class="search-page">
  <div class="container">
    <div class="search-header">
      <h1 class="search-title">{{ i18n "search_page_title" | default "Cerca Contenuti" }}</h1>
      <p class="search-description">
        {{ i18n "search_page_description" | default "Trova articoli, newsletter, podcast e video usando la ricerca avanzata." }}
      </p>
    </div>
    
    <!-- Search Form -->
    <div class="search-form-container">
      <form id="search-form" class="search-form">
        <!-- Main search input -->
        <div class="search-input-group">
          <input type="search" 
                 id="search-query" 
                 name="q" 
                 placeholder="{{ i18n "search_placeholder" | default "Cerca contenuti..." }}"
                 class="search-input-main"
                 autocomplete="off"
                 autofocus>
        </div>
        
        <!-- Filter buttons -->
        <div class="search-filters">
          <button type="button" class="filter-btn active" data-filter="all">
            {{ i18n "filter_all" | default "Tutti" }}
          </button>
          <button type="button" class="filter-btn" data-filter="articles">
            {{ i18n "filter_articles" | default "Articoli" }}
          </button>
          <button type="button" class="filter-btn" data-filter="newsletters">
            {{ i18n "filter_newsletters" | default "Newsletter" }}
          </button>
          <button type="button" class="filter-btn" data-filter="podcasts">
            {{ i18n "filter_podcasts" | default "Podcast" }}
          </button>
          <button type="button" class="filter-btn" data-filter="videos">
            {{ i18n "filter_videos" | default "Video" }}
          </button>
        </div>
      </form>
    </div>
    
    <!-- Search Results -->
    <div id="search-results" class="search-results">
      <!-- Initial state message -->
      <div id="search-initial" class="search-message">
        <div class="icon">üîç</div>
        <p>{{ i18n "search_initial_message" | default "Digita qualcosa per iniziare la ricerca..." }}</p>
      </div>
      
      <!-- Loading state -->
      <div id="search-loading" class="search-message" style="display: none;">
        <div class="icon-small">‚è≥</div>
        <p>{{ i18n "search_loading" | default "Ricerca in corso..." }}</p>
      </div>
      
      <!-- No results state -->
      <div id="search-no-results" class="search-message" style="display: none;">
        <div class="icon">üì≠</div>
        <h3>{{ i18n "no_results" | default "Nessun risultato trovato" }}</h3>
        <p>{{ i18n "search_no_results_description" | default "Prova con parole chiave diverse o rimuovi alcuni filtri." }}</p>
      </div>
      
      <!-- Results container -->
      <div id="search-results-container" class="search-results-grid" style="display: none;">
        <!-- Results will be dynamically inserted here -->
      </div>
    </div>
  </div>
</section>


<!-- Search JSON data for JavaScript -->
<script type="application/json" id="search-data">
{{ $pages := where .Site.RegularPages "Type" "in" (slice "articles" "newsletters" "podcasts" "videos") }}
{{ $searchData := slice }}
{{ range $pages }}
  {{ $item := dict 
    "title" .Title 
    "url" .Permalink
    "content" (.Plain | truncate 500)
    "summary" (.Summary | plainify | truncate 200)
    "date" (.Date.Format "2006-01-02")
    "dateFormatted" (.Date.Format "2 January 2006")
    "type" .Type
    "tags" .Params.tags
    "categories" .Params.categories
    "keywords" .Params.keywords
    "author" (.Params.author | default "")
    "duration" (.Params.duration | default "")
    "episode_number" (.Params.episode_number | default "")
    "newsletter_number" (.Params.newsletter_number | default "")
  }}
  {{ $searchData = $searchData | append $item }}
{{ end }}
{{ $searchData | jsonify | safeJS }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchForm = document.getElementById('search-form');
  const searchInput = document.getElementById('search-query');
  const filterButtons = document.querySelectorAll('.filter-btn');
  const resultsContainer = document.getElementById('search-results-container');
  const initialMessage = document.getElementById('search-initial');
  const loadingMessage = document.getElementById('search-loading');
  const noResultsMessage = document.getElementById('search-no-results');
  
  if (!searchForm || !searchInput) return;
  
  let searchData = [];
  let currentFilter = 'all';
  
  // Load search data
  try {
    const dataElement = document.getElementById('search-data');
    if (dataElement) {
      searchData = JSON.parse(dataElement.textContent);
    }
  } catch(e) {
    console.warn('Failed to load search data');
  }
  
  // Filter button handlers
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      
      if (searchInput.value.trim()) {
        performSearch(searchInput.value.trim());
      }
    });
  });
  
  // Search input handler
  let searchTimer;
  function handleSearchInput() {
    clearTimeout(searchTimer);
    const query = searchInput.value.trim();
    
    if (query.length < 2) {
      showInitialState();
      return;
    }
    
    showLoadingState();
    searchTimer = setTimeout(() => performSearch(query), 300);
  }
  
  searchInput.addEventListener('input', handleSearchInput);
  
  // URL params handling
  const urlParams = new URLSearchParams(window.location.search);
  const initialQuery = urlParams.get('q');
  if (initialQuery) {
    searchInput.value = initialQuery;
    performSearch(initialQuery);
  }
  
  function performSearch(query) {
    if (!searchData.length) {
      showNoResults();
      return;
    }
    
    const filtered = searchData.filter(item => {
      // Filter by type
      if (currentFilter !== 'all' && item.type !== currentFilter) {
        return false;
      }
      
      // Search in title, content, tags, categories, and keywords
      const searchText = `${item.title} ${item.content} ${(item.tags || []).join(' ')} ${(item.categories || []).join(' ')} ${(item.keywords || []).join(' ')}`.toLowerCase();
      return searchText.includes(query.toLowerCase());
    });
    
    if (filtered.length === 0) {
      showNoResults();
    } else {
      showResults(filtered, query);
    }
  }
  
  function showInitialState() {
    hideAllStates();
    initialMessage.style.display = 'block';
  }
  
  function showLoadingState() {
    hideAllStates();
    loadingMessage.style.display = 'block';
  }
  
  function showNoResults() {
    hideAllStates();
    noResultsMessage.style.display = 'block';
  }
  
  function showResults(results, query) {
    hideAllStates();
    resultsContainer.style.display = 'grid';
    
    resultsContainer.innerHTML = results.map(item => {
      const badge = getBadgeHTML(item);
      const meta = getMetaHTML(item);
      const tags = getTagsHTML(item);
      
      return `
        <article class="search-result-card">
          <div class="search-result-header">
            ${badge}
            <div class="search-result-meta">${meta}</div>
          </div>
          
          <h3 class="search-result-title">
            <a href="${item.url}">${highlightQuery(item.title, query)}</a>
          </h3>
          
          <div class="search-result-excerpt">
            ${highlightQuery(item.summary, query)}
          </div>
          
          ${tags}
        </article>
      `;
    }).join('');
  }
  
  function hideAllStates() {
    initialMessage.style.display = 'none';
    loadingMessage.style.display = 'none';
    noResultsMessage.style.display = 'none';
    resultsContainer.style.display = 'none';
  }
  
  function getBadgeHTML(item) {
    const badges = {
      articles: `<span class="search-result-badge badge-article">Articolo</span>`,
      newsletters: `<span class="search-result-badge badge-newsletter">${item.newsletter_number ? `Newsletter #${item.newsletter_number}` : 'Newsletter'}</span>`,
      podcasts: `<span class="search-result-badge badge-podcast">${item.episode_number ? `Episodio #${item.episode_number}` : 'Podcast'}</span>`,
      videos: `<span class="search-result-badge badge-video">Video</span>`
    };
    return badges[item.type] || `<span class="search-result-badge badge-article">${item.type}</span>`;
  }
  
  function getMetaHTML(item) {
    let meta = `<time datetime="${item.date}">${item.dateFormatted}</time>`;
    if (item.author) meta = `<span class="search-author">${item.author}</span> ¬∑ ${meta}`;
    if (item.duration) meta += ` ¬∑ <span class="search-duration">${item.duration}</span>`;
    return meta;
  }
  
  function getTagsHTML(item) {
    const allTerms = [...(item.tags || []), ...(item.keywords || [])];
    if (!allTerms.length) return '';
    return `
      <div class="search-result-tags">
        ${allTerms.slice(0, 5).map(term => 
          `<span class="search-result-tag">${term}</span>`
        ).join('')}
      </div>
    `;
  }
  
  function highlightQuery(text, query) {
    if (!query || query.length < 2) return text;
    const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<mark class="search-highlight">$1</mark>');
  }
});
</script>
{{ end }}
